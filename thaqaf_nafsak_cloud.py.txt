# ‚òÅÔ∏è ÿ´ŸÇŸÅ ŸÜŸÅÿ≥ŸÉ - Cloud Function Version
import google.generativeai as genai
import gspread
from datetime import datetime
import os
from google.auth import default

# Configuration
GOOGLE_API_KEY = "AIzaSyDf1H1PB5RWzQOFO_4n_O8qGfHFyYwBc50"
SHEET_ID = "1e70e5BvNuQFQtipB-7hYY6U1eUn4_OkLCn0-PG3BHM8"

def generate_daily_news_cloud(event, context):
    """Cloud Function to generate daily AI news"""
    print("üöÄ Starting ÿ´ŸÇŸÅ ŸÜŸÅÿ≥ŸÉ Cloud Automation...")
    
    try:
        # Configure AI
        genai.configure(api_key=GOOGLE_API_KEY)
        model = genai.GenerativeModel('models/gemini-2.0-flash')
        
        # Our perfected prompt
        prompt = """
        You are "ÿ´ŸÇŸÅ ŸÜŸÅÿ≥ŸÉ" (Educate Yourself), a multilingual AI news content generator.
        ONLY select Artificial Intelligence (AI) news from the last 48 hours.

        Output the email in THREE languages: Arabic, French, and English. Use this exact structure:

        Subject: [English AI News Title]

        üåç MULTILINGUAL CONTENT PACKAGE

        ÿßŸÑÿπÿ±ÿ®Ÿäÿ© (Arabic)
        üì∑ ÿ•ŸÜÿ≥ÿ™ÿ∫ÿ±ÿßŸÖ: [Arabic Instagram script]
        üíº ŸÑŸäŸÜŸÉÿØÿ•ŸÜ: [Arabic LinkedIn post]  
        üê¶ ùïè (ÿ™ŸàŸäÿ™ÿ±): [Arabic X thread]
        üìò ŸÅŸäÿ≥ÿ®ŸàŸÉ: [Arabic Facebook post]

        Fran√ßais (French)
        üì∑ Instagram: [French Instagram script]
        üíº LinkedIn: [French LinkedIn post]
        üê¶ X: [French X thread]
        üìò Facebook: [French Facebook post]

        English  
        üì∑ Instagram: [English Instagram script]
        üíº LinkedIn: [English LinkedIn post]
        üê¶ X: [English X thread]
        üìò Facebook: [English Facebook post]

        üîó ÿßŸÑŸÖÿµÿØÿ±/Source/Source: [URL] - ÿßŸÑŸÜÿ¥ÿ±/Published/Publi√©: [Date]
        üñºÔ∏è ŸÉŸÑŸÖÿ© ÿßŸÑÿµŸàÿ±ÿ©/Image Keyword/Mot-cl√© image: [Keyword]
        """
        
        # Generate content
        response = model.generate_content(prompt)
        
        # Extract news title
        news_title = "Unknown Title"
        if "Subject:" in response.text:
            news_title = response.text.split("Subject:")[1].split("\n")[0].strip()
        
        # Log to Google Sheets
        log_to_sheets_cloud(news_title, response.text[:100])
        
        print(f"‚úÖ Cloud automation completed: {news_title}")
        return f"Success: {news_title}"
        
    except Exception as e:
        print(f"‚ùå Cloud function error: {e}")
        return f"Error: {str(e)}"

def log_to_sheets_cloud(news_title, content_preview):
    """Log to Google Sheets from cloud"""
    try:
        # Authenticate
        creds, _ = default()
        gc = gspread.authorize(creds)
        
        # Open sheet
        sheet = gc.open_by_key(SHEET_ID)
        worksheet = sheet.sheet1
        
        # Add row
        new_row = [
            datetime.now().strftime('%Y-%m-%d'),
            datetime.now().strftime('%H:%M:%S'),
            news_title[:50] + "..." if len(news_title) > 50 else news_title,
            "Multilingual (AR/FR/EN)",
            "Instagram, LinkedIn, X, Facebook", 
            "‚úÖ Cloud Generated",
            content_preview[:100] + "..."
        ]
        
        worksheet.append_row(new_row)
        print("‚úÖ Logged to Google Sheets from cloud")
        
    except Exception as e:
        print(f"‚ùå Sheets logging error: {e}")

# For testing
if __name__ == "__main__":
    result = generate_daily_news_cloud(None, None)
    print(result)